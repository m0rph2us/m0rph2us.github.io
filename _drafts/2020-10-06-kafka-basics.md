---
layout: post
excerpt_separator: <!--more-->
title: 'Kafka Basics'
categories: kafka 카프카 
---

# 카프카 시작하기
## 개요

이번 포스팅에서는 카프카의 기본 개념부터 시작해서 클러스터 구성 및 샘플 예제를 살펴보려고 한다. 
<!--more-->

## 카프카

## 기본 개념들
 
카프카를 사용하면서 주로 사용하는 개념은 다음과 같다.

* 브로커
    * 하나의 카프카 서버를 의미한다.
    * 이런 브로커들을 묶어 카프카 클러스터를 만들게 된다.
    * 최소 3 대 이상이 무난하다.
* 토픽
    * 토픽은 프로듀싱한 메시지가 담기는 통 쯤으로 생각하면 된다.
* 메시지
    * 메시지는 키와 값, 헤더로 구성된다.
* 파티션
    * 토픽 내부에서 메시지가 담기는 구획 구간이다.
    * 메시지가 어느 구획에 담길지는 메시지 키에 의해 결정되며, 동일한 메시지 키를 가진 메시지는 항상 같은 파티션으로 담긴다.
    * 키가 `NULL` 이라면 랜덤하게 배분된다.
* 리플리케이션 팩터(RF)
    * 복제량으로, 클러스터 내에 몇 개의 사본이 존재하는지이다.
    * 이 값을 3 으로 한다면 카프카 클러스터내에 원본 메시지 포함 총 3 개의 메시지 사본이 존재하게 된다.
    * 이 값은 브로커 수 이하여야 한다. 2 ~ 3 정도로 설정하는 것이 무난하다. 
* 인싱크 레플리카(ISR)
    * 메시지를 프로듀싱할 때 몇 개가 복제됐을 때 프로듀싱을 성공한 것으로 보는지이다.
    * 이 값은 RF 값 이하로 설정해야 프로듀싱 오류가 발생하지 않는다. 예상치 못한 브로커의 셧다운을 고려해서 RF + (-1 ~ -2) 정도로 설정하는 것이 좋다.
* 프로듀서
    * 토픽에 메시지를 프로듀싱하는 주체이다.
* 컨슈머
    * 토픽에서 메시지를 컨슘하는 주체이다.
    * 하나의 컨슈머는 서로 다른 토픽 하나씩을 컨슘할 수 있다.
* 컨슈머 그룹
    * 컨슈머는 컨슈머 그룹으로 묶을 수 있다.
    * 같은 컨슈머 그룹에 속한 컨슈머는 코디네이터에 의해 각기 다른 파티션을 컨슘하게 된다.
    
## 만약에 브로커가 3 개, RF 가 3 인 상태에서 브로커 1 대가 셧다운 된다면?

아찔한 순간이지만 운영중에 서버가 복구 불가능해지는 상황은 얼마든지 발생할 수 있다. 

* ISR 이 3 인 경우
    * 이 경우에는 메시지가 프로듀싱되지 않고 오류가 발생하게 된다. 왜냐하면 메시지가 프로듀싱 되기 위해서는 3 개의 사본 생성이 확인되어야 하기 때문이다.
* ISR 이 2 이하인 경우
    * 프로듀싱은 문제없이 동작한다.
    * 컨슈밍은 리더(leader) 브로커가 변경될 수 있다.
    
이 경우 셧다운된 브로커가 복구되면 복구된 브로커는 유실된 데이터를 다시 채우게 된다.

## 샘플 클러스터

## 샘플 예제

## 마무리

## 참고

